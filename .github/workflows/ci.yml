name: Confirm tests run successfully

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    name: Verify tests pass

    runs-on: ubuntu-latest

    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        container_image:
          - docker.io/library/ubuntu:22.04
          - docker.io/library/ubuntu:24.04
          - docker.io/library/ubuntu:25.04
          - docker.io/library/ubuntu:25.10
          - docker.io/library/ubuntu:26.04
        dotnet_version:
          - "8"
          - "9"
          - "10"
    container:
      image: ${{ matrix.container_image }}
      options: --security-opt seccomp=unconfined
      env:
        DEBIAN_FRONTEND: noninteractive
    steps:
      - uses: actions/checkout@v6

      - name: Enable -proposed
        run: |
          set -euo pipefail
          codename=$(. /etc/os-release && echo $VERSION_CODENAME)
          # Check if system uses DEB822 format (24.04+)
          if [[ -d /etc/apt/sources.list.d ]] && [[ -f /etc/apt/sources.list.d/ubuntu.sources ]]; then
            echo "Using DEB822 format (Ubuntu 24.04+)"
            # Enable proposed pocket in DEB822 format
            cat >> /etc/apt/sources.list.d/ubuntu.sources <<EOF
          Types: deb
          URIs: http://archive.ubuntu.com/ubuntu/
          Suites: ${codename}-proposed
          Components: main restricted universe multiverse
          Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg
          EOF
            cat >> /etc/apt/preferences.d/dotnet-proposed <<EOF
          Package: src:dotnet*
          Pin: release a=${codename}-proposed
          Pin-Priority: 990
          EOF
          else
            echo "Using traditional sources.list format (Ubuntu < 24.04)"
            # Enable proposed pocket in traditional format
            echo "deb http://archive.ubuntu.com/ubuntu/ ${codename}-proposed main restricted universe multiverse" >> /etc/apt/sources.list
          fi
          echo "Proposed pocket enabled for ${codename}"
        shell: bash

      - name: Install test dependencies
        timeout-minutes: 5
        run: |
          apt-get update && apt-get install --yes wget tar sudo
          apt-get update && apt-get install --yes $(grep -A 3 '^#### apt$' README.md | tail -n 1 | tr -d '`')
        shell: bash

      - name: Install .NET ${{ matrix.dotnet_version }}
        id: install-dotnet
        timeout-minutes: 10
        run: |
          set -euo pipefail
          check_and_add_ppa() {
            local ppa=$1
            local codename=$(. /etc/os-release && echo $VERSION_CODENAME)
            local ppa_owner=$(echo $ppa | cut -d/ -f1)
            local ppa_name=$(echo $ppa | cut -d/ -f2)
            
            if curl -sf "https://ppa.launchpadcontent.net/${ppa_owner}/${ppa_name}/ubuntu/dists/${codename}/Release" > /dev/null; then
              echo "Adding PPA ${ppa} (supports ${codename})"
              add-apt-repository --yes ppa:${ppa}
            else
              echo "Skipping PPA ${ppa} (does not support ${codename})"
            fi
          }
          cat /etc/os-release
          version_id=$(. /etc/os-release && echo $VERSION_ID)
          # if release is LTS, add backports and preview PPAs
          case "$version_id" in
            22.04|24.04|26.04) # update this list as new LTS releases come out
              echo "Adding backports and previews PPAs."
              apt-get update && apt-get install --yes software-properties-common
              check_and_add_ppa dotnet/backports
              check_and_add_ppa dotnet/previews
              ;;
          esac
          dotnet_version_number=$(echo "${{ matrix.dotnet_version }}" | cut -d' ' -f1)
          apt-get update && apt-get install --yes --install-suggests dotnet${dotnet_version_number}
          dotnet --info
          echo "version-id=${version_id}" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Download test runner
        run: |
          set -euo pipefail
          wget --no-verbose https://github.com/canonical/dotnet-test-runner/releases/latest/download/turkey.tar.gz
          tar xf turkey.tar.gz
        shell: bash

      - name: Run tests
        run: |
          set -euo pipefail
          echo "Creating testrunner user"
          useradd testrunner --create-home
          chown --recursive testrunner:testrunner /home/testrunner/
          mkdir TestResults
          echo "Turkey version:"
          dotnet turkey/Turkey.dll --version
          echo "Running tests with .NET ${{ matrix.dotnet_version }} on ${{ matrix.container_image }}"
          dotnet turkey/Turkey.dll -v --timeout 600 --log-directory TestResults --trait github-ci
        shell: bash

      - name: Upload Test Results
        if: ${{ always() }}
        uses: actions/upload-artifact@v6
        with:
          name: ${{ format('TestResults-{0}-dotnet{1}', steps.install-dotnet.outputs.version-id, matrix.dotnet_version) }}
          path: TestResults
